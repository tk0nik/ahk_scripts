;---функции---;
copy(){
	clipboard := "" ;очистка буфера обмена
	while (clipboard != "")
		continue
	send ^c
	clipwait 
	return clipboard
}

;--- мелочь: вставка даты. ---;
^;::send %a_dd%.%a_mm%.%a_yyyy% {right}

;---Назначаю Alt+c сочетанием "умного копирования" из поступления 1с 
;-----(возможно, позднее также из заявки otrs)
!c::
	setTitleMatchMode 2
	if WinActive(" База ahk_exe 1cv8c.exe"){
		msgbox умное копирование данных из ПТУ
		send ^{f11}
		sleep 400  
		send {enter}
		send {enter}
		send {esc}
		send +{f11}
		send ^v
		send {enter}
		sleep 200
		send +{tab}
		ptu := copy()
		send {tab}
		;ptu_date := copy() 	;надо бы узнать, используется ли где-нибудь дата поступления
		send {tab}
		contragent := copy()
		send {tab 3} ;договор, конечное мх, заказ
		full_order := RegExReplace(copy(), "Заказ поставщику ", "")
		order := RegExReplace(full_order, SubStr(full_order, InStr(full_order, " ") + 1), "")
		;можно добавить вычисление даты заказа
		send {tab 2}	;вид операции, организвция
		org := copy()
		send {tab 2}	;подразделение-получатель, валюта КА
		curr := copy()
		send {tab 4}	;курс на датц поступления и кратность, комментарий
		invoice_date := copy()
		send {tab}
		invoice := copy()
		
		msgbox % invoice
		
	}
	else{
		msgbox умное копирование пока доступно только для пту 1с
	}

;---Назначаю Alt+Q сочетанием заполнения Excel-шаблонов---;
!q:: 
	
	ifWinActive, Сертификат происхождения товара.xlsm - Excel
	{
		; потенциальные проблемы: отсутствие ГТД в 1С в поступлениях
		; необходимость ссылки 
		; проблема долгого открытия 1с
		;возможность оптимизации: добавить чтение зеленых ячеек из гтд 1с, запилить авто преференции
		msgbox, Запустить заполнение шаблона "Сертификат"
		;проставляем дату
		send {esc}^g 
		winwait Переход
		send {raw}Расчет!D2
		send {enter}
		sleep 200
		send %a_dd%.%a_mm% 
		sleep 100
		send {enter}^g 
		;заполнение листа Расчет 
		winwait Переход
		send {raw}Расчет!A7
		send {enter}
		sleep 200
		;переход в 1с
		setTitleMatchMode 2		
		inputbox url
		run "C:\Program Files\1cv8\common\1cestart.exe" /URL "%url%", C:\Program Files\1cv8\common
		;sleep 500
		winwait База ahk_exe 1cv8c.exe
		winActivate
		if WinActive(" База ahk_exe 1cv8c.exe")
		{	
			;-----костыль на случай курсора хз где
			sleep 500
			send {esc}
			send +{f11}
			clipboard := url
			send ^v
			send {enter}
			sleep 800
			;-----
			send +{tab}
			ptu := copy()
			send {tab 2}
			contragent := copy()
			send ^+{f4}{tab 18}^+{f4}{tab 3}
			ca_country := copy()
			send {esc 2}
			send {tab 3}
			full_order := RegExReplace(copy(), "Заказ поставщику ", "")
			order := RegExReplace(full_order, SubStr(full_order, InStr(full_order, " ") + 1), "")
			send {tab 2}
			org := copy()
			send {tab 2}
			curr := copy()	;валюта
			send {tab 4}
			invoice_date := copy()
			send {tab}
			invoice := copy()
			;--- товар
			send {tab 3}{right}
			product := copy()
			send {left}			
			loop 28
				send +{tab}
			send {enter}
			sleep 2000
			;--- этот кусок будет работать только при нормальной скорости работы 1с и буфера обмена windows
			send ^fгтд 
			send {enter}
			sleep 500
			;буфер обмена после поиска
			send ^c
			sleep 500
			
			if (clipboard = product){
				msgbox ГТД не найдена, сорян.
				send {esc}
				send {tab 39}
				product_cost := RegExReplace(copy(), " ", "")
				send {esc}
				
			}
			else{
				tooltip
				send {enter}
				sleep 1000
				send {tab 5}
				cust := copy()
				send {tab 2}
				gtd := copy()
				send {esc 2}
				send {tab 39}
				product_cost := RegExReplace(copy(), " ", "")
				send {esc}
			}
			
			; ---вставка данных
			WinActivate Сертификат происхождения товара.xlsm - Excel 
			winwaitActive Сертификат происхождения товара.xlsm - Excel 
			;Заполнение листа Расчет
			sleep 500
			clipboard = %contragent%`t%product%`t%invoice%`t%invoice_date%`t%order%`t%gtd%`t
			send ^v
			sleep 200
			send {esc}^g 
			winwait Переход
			send {raw}Расчет!H7
			send {enter}
			sleep 200
			clipboard = %cust%
			send ^v
			sleep 200
			send {esc}^g 
			winwait Переход
			send {raw}Расчет!U7
			send {enter}
			sleep 200
			clipboard = %curr%
			send ^v
			; заполнение листа РП
			sleep 200
			send {esc}^g 
			winwait Переход
			send {raw}РП!A2
			send {enter}
			sleep 200
			clipboard = %org%
			send ^v{right 4}
			sleep 200
			clipboard = %ca_country%
			send ^v
			sleep 200
			send {esc}^g 
			winwait Переход
			send {raw}РП!R2
			send {enter}
			sleep 200
			clipboard = %ptu%
			send ^v
			sleep 200
			;заполнение стоимости на листе Расчет
			send {esc}^g 
			winwait Переход
			send {raw}Расчет!S11
			send {enter}
			sleep 200
			clipboard = %product_cost%
			sleep 200
			send ^v
			tooltip
			msgbox заполнение завершено
			clipboard = %url%
		}
		else 
		{
			msgbox не удалось открыть поступление. какая-то хрень.
		}
		
		return
	}
